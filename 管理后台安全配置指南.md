# 管理后台安全配置指南 - 方案 3：环境变量保护

## 什么是环境变量？

环境变量是存储在服务器上的 **秘密配置信息**，不会被上传到 GitHub 或暴露在代码中。

### 对比

```javascript
// ❌ 不安全：密码在代码中
const adminPassword = "admin123"
// 任何人看代码都能看到密码

// ✅ 安全：密码在环境变量中
const adminPassword = process.env.ADMIN_PASSWORD
// 密码只存在服务器上，代码中看不到
```

## 实现步骤

### 步骤 1：在微信云托管中设置环境变量

1. **登录微信云托管控制台**
   - 访问 https://console.cloud.tencent.com/tcb

2. **进入你的服务**
   - 找到 `express-iayq` 服务

3. **进入服务设置**
   - 点击 **服务设置** 或 **环境变量**

4. **添加环境变量**
   ```
   变量名: ADMIN_PASSWORD
   变量值: your-very-secure-password-here
   ```

   例如：
   ```
   变量名: ADMIN_PASSWORD
   变量值: MySecureAdminPass2025!@#
   ```

5. **保存并重新部署**
   - 点击保存
   - 重新部署服务

### 步骤 2：在后端代码中使用环境变量

**创建认证中间件** (`server/middleware/adminAuth.js`)：

```javascript
const adminAuth = (req, res, next) => {
  // 从环境变量中获取管理员密码
  const adminPassword = process.env.ADMIN_PASSWORD || 'admin123'

  // 从请求头中获取密码
  const password = req.headers['x-admin-password']

  // 验证密码
  if (!password || password !== adminPassword) {
    return res.status(401).json({
      success: false,
      message: '未授权：管理员密码错误'
    })
  }

  // 密码正确，继续处理
  next()
}

module.exports = adminAuth
```

**在管理路由中使用** (`server/routes/admin.js`)：

```javascript
const express = require('express')
const router = express.Router()
const adminAuth = require('../middleware/adminAuth')

// 应用认证中间件
router.use(adminAuth)

// 所有管理员路由都需要认证
router.get('/stats', async (req, res) => {
  // ...
})

router.get('/users', async (req, res) => {
  // ...
})

// ... 其他路由
```

### 步骤 3：在前端访问管理后台时提供密码

**方式 1：在请求头中提供密码（推荐）**

```javascript
// 访问管理后台时
fetch('https://your-domain.com/api/admin/stats', {
  headers: {
    'x-admin-password': 'your-admin-password'
  }
})
```

**方式 2：在 URL 中提供密码（仅用于测试）**

```
https://your-domain.com/api/admin/stats?adminPassword=your-admin-password
```

## 工作流程

```
1. 用户访问管理后台
   ↓
2. 输入管理员密码
   ↓
3. 前端将密码发送到后端（在请求头中）
   ↓
4. 后端验证密码
   ├─ 密码正确 → 返回数据
   └─ 密码错误 → 返回 401 未授权
```

## 安全最佳实践

### ✅ 应该做的

1. **使用强密码**
   ```
   ✅ MySecureAdminPass2025!@#
   ❌ admin123
   ❌ password
   ```

2. **定期更换密码**
   - 每 3 个月更换一次
   - 在环境变量中更新

3. **记录访问日志**
   ```javascript
   console.log(`[管理员访问] IP: ${req.ip}, 时间: ${new Date()}`)
   ```

4. **限制访问频率**
   ```javascript
   // 添加速率限制
   const rateLimit = require('express-rate-limit')
   const adminLimiter = rateLimit({
     windowMs: 15 * 60 * 1000, // 15 分钟
     max: 100 // 限制 100 个请求
   })
   router.use(adminLimiter)
   ```

5. **使用 HTTPS**
   - 已有 ✅

### ❌ 不应该做的

1. **不要在代码中硬编码密码**
   ```javascript
   ❌ const password = "admin123"
   ```

2. **不要在 URL 中暴露密码**
   ```
   ❌ /admin?password=admin123
   ```

3. **不要使用简单密码**
   ```
   ❌ admin, 123456, password
   ```

4. **不要忘记更换默认密码**

## 测试

### 测试 1：使用正确的密码

```bash
curl -H "x-admin-password: your-admin-password" \
  https://your-domain.com/api/admin/stats
```

预期结果：返回统计数据 ✅

### 测试 2：使用错误的密码

```bash
curl -H "x-admin-password: wrong-password" \
  https://your-domain.com/api/admin/stats
```

预期结果：返回 401 未授权 ✅

### 测试 3：不提供密码

```bash
curl https://your-domain.com/api/admin/stats
```

预期结果：返回 401 未授权 ✅

## 常见问题

### Q1：如果忘记了管理员密码怎么办？

**A：** 在微信云托管中重新设置环境变量，然后重新部署服务。

### Q2：可以有多个管理员吗？

**A：** 可以，修改认证逻辑：

```javascript
const adminPasswords = [
  process.env.ADMIN_PASSWORD_1,
  process.env.ADMIN_PASSWORD_2,
  process.env.ADMIN_PASSWORD_3
]

if (!adminPasswords.includes(password)) {
  return res.status(401).json({ message: '未授权' })
}
```

### Q3：如何添加更多的安全层？

**A：** 可以添加：
- IP 白名单
- 速率限制
- 审计日志
- 两因素认证（2FA）

## 相关文件

- `server/middleware/adminAuth.js` - 认证中间件
- `server/routes/admin.js` - 管理员路由
- `server/index.js` - 主服务器文件

## 总结

| 方面 | 说明 |
|------|------|
| **安全性** | ⭐⭐⭐⭐ 高 |
| **易用性** | ⭐⭐⭐ 中等 |
| **实现难度** | ⭐⭐ 简单 |
| **推荐指数** | ⭐⭐⭐⭐⭐ 强烈推荐 |

## 下一步

1. 创建 `server/middleware/adminAuth.js` 文件
2. 在 `server/routes/admin.js` 中使用认证中间件
3. 在微信云托管中设置 `ADMIN_PASSWORD` 环境变量
4. 重新部署服务
5. 测试管理后台访问

---

**需要帮助吗？** 我可以帮你：
1. 创建认证中间件文件
2. 修改管理路由
3. 设置环境变量
4. 测试认证功能

