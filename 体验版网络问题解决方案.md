# 体验版网络连接问题解决方案

## 问题描述
- ✅ 微信开发工具可以正常访问云托管
- ❌ 手机扫码体验版提示网络连接失败

## 根本原因

体验版的小程序有更严格的安全限制：
1. **云调用权限限制** - 体验版可能无法使用云调用功能
2. **域名未配置** - 公网访问需要在微信公众平台配置合法域名

## 解决方案

### 步骤 1：配置合法域名（必须）

这是最重要的一步！

1. **登录微信公众平台**
   - 访问 https://mp.weixin.qq.com
   - 使用你的小程序账号登录

2. **进入开发设置**
   - 点击 **开发** → **开发设置**

3. **配置服务器域名**
   - 找到 **服务器域名** 部分
   - 在 **request 合法域名** 中添加：
     ```
     https://express-iayq-202839-6-1388611962.sh.run.tcloudbase.com
     ```
   - 点击 **保存**

4. **重新上传小程序**
   - 在微信开发者工具中上传新版本
   - 等待审核通过（通常几分钟）

### 步骤 2：更新小程序代码（已完成）

我已经更新了 `app.js` 中的 `call()` 方法：

```javascript
// 体验版和正式版使用公网访问
if (envVersion === 'trial' || envVersion === 'release') {
  console.log('体验版/正式版：使用公网访问')
  return await that.callPublic(options)
}
```

这样体验版会自动使用公网访问，而不是云调用。

### 步骤 3：重新上传体验版

1. 在微信开发者工具中
2. 点击 **上传** 按钮
3. 填写版本号和备注
4. 上传为 **体验版**

### 步骤 4：重新扫码体验

1. 在微信公众平台找到体验版二维码
2. 用微信扫码
3. 尝试登录

## 验证步骤

### 在手机上验证

1. **打开体验版小程序**
2. **打开调试模式**
   - 在小程序中长按 2 秒
   - 选择 **打开调试**
3. **查看控制台日志**
   - 应该看到：`当前环境: trial`
   - 应该看到：`体验版/正式版：使用公网访问`
4. **尝试登录**
   - 输入用户名和密码
   - 观察是否能成功连接

## 常见问题

### Q1: 配置了域名还是不行？

**可能原因：**
- 域名配置后需要重新上传小程序
- 体验版需要重新生成二维码

**解决：**
1. 确保已保存域名配置
2. 在开发工具中重新上传
3. 重新生成体验版二维码
4. 用新的二维码扫码

### Q2: 显示"域名不合法"

**原因：** 域名未在微信公众平台配置

**解决：**
1. 登录微信公众平台
2. 进入 **开发** → **开发设置**
3. 在 **request 合法域名** 中添加域名
4. 保存并重新上传小程序

### Q3: 开发工具可以，体验版不行

**原因：** 开发工具有特殊权限，体验版没有

**解决：**
1. 确保已配置合法域名
2. 确保已上传新版本代码
3. 确保体验版二维码是最新的

### Q4: 如何查看体验版的日志？

**方法：**
1. 在小程序中长按 2 秒
2. 选择 **打开调试**
3. 点击 **vConsole** 标签
4. 查看 **Log** 中的日志信息

## 代码变更说明

### 环境检测逻辑

```javascript
const accountInfo = wx.getAccountInfoSync()
const envVersion = accountInfo.miniProgram.envVersion

// envVersion 的可能值：
// - 'develop'  : 开发版
// - 'trial'    : 体验版
// - 'release'  : 正式版
```

### 调用策略

| 环境 | 调用方式 | 说明 |
|------|--------|------|
| 开发版 | 云调用 → 公网 | 优先云调用，失败时降级 |
| 预览版 | 云调用 → 公网 | 优先云调用，失败时降级 |
| 体验版 | 公网 | 直接使用公网访问 |
| 正式版 | 公网 | 直接使用公网访问 |

## 测试清单

- [ ] 在微信公众平台配置了合法域名
- [ ] 在开发工具中上传了新版本代码
- [ ] 重新生成了体验版二维码
- [ ] 用新二维码扫码进入体验版
- [ ] 在体验版中打开调试模式
- [ ] 查看日志显示 `当前环境: trial`
- [ ] 查看日志显示 `体验版/正式版：使用公网访问`
- [ ] 尝试登录，成功连接

## 如果仍然不行

如果按照以上步骤仍然无法连接，请：

1. **检查云托管服务状态**
   - 登录微信云托管控制台
   - 确保服务状态为 **运行中**
   - 查看运行日志是否有错误

2. **检查后端服务**
   - 确保 Node.js 服务器正常运行
   - 检查数据库是否正确初始化
   - 查看服务器日志

3. **测试公网访问**
   - 在浏览器中访问：
     ```
     https://express-iayq-202839-6-1388611962.sh.run.tcloudbase.com/api/auth/login
     ```
   - 应该返回 404 或其他 HTTP 错误（但不是连接超时）

4. **收集调试信息**
   - 打开体验版调试模式
   - 复制完整的错误日志
   - 提供给技术支持

## 相关文件

- `app.js` - 已更新，支持环境检测和自动选择调用方式
- `pages/login/login.js` - 登录页面
- `云调用配置指南.md` - 云调用详细配置
- `网络问题排查指南.md` - 网络问题排查

## 更新日志

- 2025-11-26：添加环境检测逻辑
- 2025-11-26：体验版自动使用公网访问
- 2025-11-26：创建体验版网络问题解决方案文档

