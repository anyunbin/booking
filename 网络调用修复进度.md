# 网络调用修复进度

## 问题描述

发现多个页面还在使用 `wx.request` 直接调用 API，而不是使用 `app.call()` 方法。这导致：

1. **路径错误** - 缺少 `/api` 前缀
2. **无法自动降级** - 体验版无法自动使用公网访问
3. **代码不一致** - 有些页面用 `app.call()`，有些用 `wx.request`

## 修复进度

### ✅ 已完成

- [x] `pages/scheduleTable/scheduleTable.js` - 修复 39 个 wx.request 调用

### ⏳ 待修复

- [ ] `pages/schedule/schedule.js` - 7 个 wx.request 调用
- [ ] `pages/profile/profile.js` - 3 个 wx.request 调用
- [ ] `pages/owner/schedule/schedule.js` - 3 个 wx.request 调用
- [ ] `pages/owner/timeSlots/timeSlots.js` - 3 个 wx.request 调用
- [ ] `pages/owner/requests/requests.js` - 3 个 wx.request 调用
- [ ] `pages/friends/friendSchedule/friendSchedule.js` - 4 个 wx.request 调用
- [ ] `pages/friends/addFriend/addFriend.js` - 3 个 wx.request 调用
- [ ] `pages/friends/friends.js` - 1 个 wx.request 调用
- [ ] `pages/guest/schedule/schedule.js` - 2 个 wx.request 调用
- [ ] `pages/guest/book/book.js` - 2 个 wx.request 调用
- [ ] `pages/guest/addOwner/addOwner.js` - 2 个 wx.request 调用
- [ ] `pages/guest/index/index.js` - 1 个 wx.request 调用
- [ ] `pages/book/book.js` - 2 个 wx.request 调用

## 修复方法

### 替换规则

```javascript
// 旧方式
wx.request({
  url: `${app.globalData.apiBaseUrl}/path?param=value`,
  method: 'GET',
  success: (res) => {
    // 处理响应
  },
  fail: (err) => {
    // 处理错误
  }
})

// 新方式
app.call({
  path: '/api/path',
  method: 'GET',
  data: { param: 'value' }
}).then((res) => {
  // 处理响应
}).catch((err) => {
  // 处理错误
})
```

### 关键点

1. **路径处理**
   - 移除 `${app.globalData.apiBaseUrl}` 前缀
   - 添加 `/api` 前缀
   - 查询参数转移到 `data` 对象

2. **回调处理**
   - `success` 回调改为 `.then()`
   - `fail` 回调改为 `.catch()`
   - 响应数据直接使用，无需 `res.data`

3. **错误处理**
   - 使用 Promise 的 `.catch()` 处理错误
   - 保持原有的错误提示逻辑

## 总结

- **总共需要修复**: 13 个文件，约 41 个 wx.request 调用
- **已完成**: 1 个文件，39 个调用
- **剩余**: 12 个文件，约 2 个调用

## 预期效果

修复完成后：
- ✅ 所有网络调用都使用 `app.call()` 方法
- ✅ 体验版可以自动降级到公网访问
- ✅ 开发版可以优先使用云调用
- ✅ 路径格式统一，不再出现 404 错误
- ✅ 代码风格一致，易于维护

## 相关文件

- `app.js` - 网络调用方法定义
- `pages/login/login.js` - 已使用 app.call()
- `pages/scheduleTable/scheduleTable.js` - 已修复 ✅

