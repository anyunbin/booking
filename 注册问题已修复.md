# 注册问题已修复

## 问题原因

数据库表 `users` 缺少 `username` 和 `password` 字段，导致注册时查询失败。

## 已完成的修复

### 1. 数据库迁移
- ✅ 已运行迁移脚本 `migrate_to_username_password.js`
- ✅ 表结构已更新，包含 `username` 和 `password` 字段
- ✅ 旧表已备份为 `users_old_backup`
- ✅ 现有数据已迁移（3条记录）

### 2. 表结构更新
新的 `users` 表包含以下字段：
- `id` - 用户ID
- `username` - 用户名（唯一）
- `password` - 加密后的密码
- `nickname` - 昵称
- `avatar_url` - 头像URL
- `name` - 姓名
- `phone` - 手机号
- `email` - 邮箱
- `created_at` - 创建时间
- `updated_at` - 更新时间
- `last_login_at` - 最后登录时间

## 下一步操作

### 1. 重启服务器

**重要：必须重启服务器才能生效！**

```bash
# 停止当前服务器（Ctrl+C）
# 然后重新启动
npm start
```

### 2. 测试注册

1. 打开小程序
2. 进入登录页面
3. 切换到"注册"标签
4. 输入：
   - 用户名：3-20个字符（例如：`testuser`）
   - 密码：至少6个字符（例如：`123456`）
   - 确认密码：与密码一致
   - 昵称：可选
5. 点击"注册"

### 3. 验证注册成功

注册成功后：
- 显示"注册成功，请登录"
- 自动切换到登录标签
- 用户名已自动填入
- 可以使用新账号登录

## 注意事项

### 迁移的旧用户

迁移脚本为旧用户自动生成了：
- `username`: `user_${id}` 格式
- `password`: 默认密码（建议重新设置）

**建议：**
- 旧用户需要重新注册或联系管理员重置密码
- 或者可以手动更新旧用户的密码

### 查看迁移后的数据

```bash
# 查看所有用户
sqlite3 server/database.db "SELECT id, username, name FROM users;"

# 查看备份的旧表
sqlite3 server/database.db "SELECT * FROM users_old_backup;"
```

## 如果还有问题

1. **检查服务器日志**：查看是否有其他错误
2. **检查网络连接**：确保手机能访问服务器
3. **清除小程序缓存**：在微信开发者工具中清除缓存
4. **查看数据库**：确认表结构正确

## 测试命令

```bash
# 测试注册API（在电脑上）
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"123456","nickname":"测试用户"}'

# 应该返回：
# {"success":true,"message":"注册成功"}
```

