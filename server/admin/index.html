<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¢„çº¦ç³»ç»Ÿç®¡ç†åå°</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-card .sub-value {
      font-size: 14px;
      color: #999;
    }

    .tabs {
      display: flex;
      background: white;
      border-radius: 10px 10px 0 0;
      padding: 0 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow-x: auto;
    }

    .tab {
      padding: 15px 25px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      white-space: nowrap;
      font-weight: 500;
    }

    .tab:hover {
      background: #f5f5f5;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .content {
      background: white;
      border-radius: 0 0 10px 10px;
      padding: 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-height: 400px;
    }

    .toolbar {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .toolbar input,
    .toolbar select {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .toolbar input {
      flex: 1;
      min-width: 200px;
    }

    .toolbar button {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    .toolbar button:hover {
      background: #5568d3;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #555;
      border-bottom: 2px solid #e0e0e0;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }

    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 15px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .pagination button:hover:not(:disabled) {
      background: #f5f5f5;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination .page-info {
      padding: 8px 15px;
      color: #666;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .empty {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .status-detail {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-item .label {
      color: #666;
      font-size: 12px;
    }

    .status-item .value {
      font-weight: 600;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š é¢„çº¦ç³»ç»Ÿç®¡ç†åå°</h1>
      <p>æ•°æ®ç»Ÿè®¡ä¸æŸ¥è¯¢ç®¡ç†</p>
    </div>

    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <h3>ç”¨æˆ·æ€»æ•°</h3>
        <div class="value" id="userTotal">-</div>
        <div class="sub-value">æœ€è¿‘7å¤©: <span id="userRecent">-</span></div>
      </div>
      <div class="stat-card">
        <h3>æ—¥ç¨‹æ€»æ•°</h3>
        <div class="value" id="scheduleTotal">-</div>
        <div class="sub-value">æœ€è¿‘7å¤©: <span id="scheduleRecent">-</span></div>
        <div class="status-detail" id="scheduleStatus"></div>
      </div>
      <div class="stat-card">
        <h3>å¥½å‹å…³ç³»</h3>
        <div class="value" id="friendTotal">-</div>
      </div>
      <div class="stat-card">
        <h3>é¢„çº¦è¯·æ±‚</h3>
        <div class="value" id="requestTotal">-</div>
        <div class="status-detail" id="requestStatus"></div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="users">ç”¨æˆ·ç®¡ç†</div>
      <div class="tab" data-tab="friends">å¥½å‹å…³ç³»</div>
      <div class="tab" data-tab="schedules">æ—¥ç¨‹ç®¡ç†</div>
      <div class="tab" data-tab="requests">é¢„çº¦è¯·æ±‚</div>
    </div>

    <div class="content">
      <!-- ç”¨æˆ·ç®¡ç† -->
      <div class="tab-content" id="users-content">
        <div class="toolbar">
          <input type="text" id="userKeyword" placeholder="æœç´¢ç”¨æˆ·å/æ˜µç§°/å§“å">
          <button onclick="searchUsers()">æœç´¢</button>
          <button onclick="loadUsers()">åˆ·æ–°</button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>ç”¨æˆ·å</th>
                <th>æ˜µç§°</th>
                <th>å§“å</th>
                <th>æ‰‹æœº</th>
                <th>é‚®ç®±</th>
                <th>æ³¨å†Œæ—¶é—´</th>
                <th>æœ€åç™»å½•</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr><td colspan="8" class="loading">åŠ è½½ä¸­...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="usersPagination"></div>
      </div>

      <!-- å¥½å‹å…³ç³» -->
      <div class="tab-content" id="friends-content" style="display: none;">
        <div class="toolbar">
          <button onclick="loadFriends()">åˆ·æ–°</button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ç”¨æˆ·</th>
                <th>å¥½å‹</th>
                <th>å»ºç«‹æ—¶é—´</th>
              </tr>
            </thead>
            <tbody id="friendsTableBody">
              <tr><td colspan="3" class="loading">åŠ è½½ä¸­...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="friendsPagination"></div>
      </div>

      <!-- æ—¥ç¨‹ç®¡ç† -->
      <div class="tab-content" id="schedules-content" style="display: none;">
        <div class="toolbar">
          <input type="text" id="scheduleUserId" placeholder="ç”¨æˆ·ID">
          <select id="scheduleStatus">
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="available">å¯ç”¨</option>
            <option value="booked">å·²é¢„çº¦</option>
            <option value="pending">å¾…å®¡æ ¸</option>
          </select>
          <input type="date" id="scheduleDate">
          <button onclick="searchSchedules()">æœç´¢</button>
          <button onclick="loadSchedules()">åˆ·æ–°</button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>ç”¨æˆ·</th>
                <th>æ—¥æœŸ</th>
                <th>æ—¶é—´</th>
                <th>çŠ¶æ€</th>
                <th>æ˜¯å¦å…¬å¼€</th>
                <th>åˆ›å»ºæ—¶é—´</th>
              </tr>
            </thead>
            <tbody id="schedulesTableBody">
              <tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="schedulesPagination"></div>
      </div>

      <!-- é¢„çº¦è¯·æ±‚ -->
      <div class="tab-content" id="requests-content" style="display: none;">
        <div class="toolbar">
          <select id="requestStatus">
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="pending">å¾…å®¡æ ¸</option>
            <option value="approved">å·²åŒæ„</option>
            <option value="rejected">å·²é©³å›</option>
          </select>
          <input type="text" id="requestOwnerId" placeholder="ä¸»äººID">
          <input type="text" id="requestGuestId" placeholder="å®¢äººID">
          <button onclick="searchRequests()">æœç´¢</button>
          <button onclick="loadRequests()">åˆ·æ–°</button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>ä¸»äºº</th>
                <th>å®¢äºº</th>
                <th>æ—¥æœŸ</th>
                <th>æ—¶é—´</th>
                <th>çŠ¶æ€</th>
                <th>å¤‡æ³¨</th>
                <th>åˆ›å»ºæ—¶é—´</th>
              </tr>
            </thead>
            <tbody id="requestsTableBody">
              <tr><td colspan="8" class="loading">åŠ è½½ä¸­...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="requestsPagination"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api'
    let currentTab = 'users'
    let currentPages = {
      users: 1,
      friends: 1,
      schedules: 1,
      requests: 1
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadStats()
      loadUsers()
      setupTabs()
    })

    // è®¾ç½®æ ‡ç­¾é¡µåˆ‡æ¢
    function setupTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab
          switchTab(tabName)
        })
      })
    }

    function switchTab(tabName) {
      currentTab = tabName
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
      document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none')
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active')
      document.getElementById(`${tabName}-content`).style.display = 'block'
      
      if (tabName === 'users') loadUsers()
      else if (tabName === 'friends') loadFriends()
      else if (tabName === 'schedules') loadSchedules()
      else if (tabName === 'requests') loadRequests()
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      try {
        const res = await fetch(`${API_BASE}/admin/stats`)
        const data = await res.json()
        if (data.success) {
          const stats = data.data
          document.getElementById('userTotal').textContent = stats.users.total
          document.getElementById('userRecent').textContent = stats.users.recent
          document.getElementById('scheduleTotal').textContent = stats.schedules.total
          document.getElementById('scheduleRecent').textContent = stats.schedules.recent
          document.getElementById('friendTotal').textContent = stats.friends.total
          document.getElementById('requestTotal').textContent = stats.requests.total
          
          // æ—¥ç¨‹çŠ¶æ€
          const scheduleStatusHtml = Object.entries(stats.schedules.byStatus).map(([status, count]) => 
            `<div class="status-item"><span class="label">${getStatusLabel(status)}:</span><span class="value">${count}</span></div>`
          ).join('')
          document.getElementById('scheduleStatus').innerHTML = scheduleStatusHtml
          
          // è¯·æ±‚çŠ¶æ€
          const requestStatusHtml = Object.entries(stats.requests.byStatus).map(([status, count]) => 
            `<div class="status-item"><span class="label">${getStatusLabel(status)}:</span><span class="value">${count}</span></div>`
          ).join('')
          document.getElementById('requestStatus').innerHTML = requestStatusHtml
        }
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error)
      }
    }

    // åŠ è½½ç”¨æˆ·åˆ—è¡¨
    async function loadUsers(page = 1) {
      currentPages.users = page
      const keyword = document.getElementById('userKeyword').value
      try {
        const params = new URLSearchParams({ page, pageSize: 20 })
        if (keyword) params.append('keyword', keyword)
        const res = await fetch(`${API_BASE}/admin/users?${params}`)
        const data = await res.json()
        if (data.success) {
          renderUsersTable(data.data.list)
          renderPagination('usersPagination', data.data.pagination, loadUsers)
        }
      } catch (error) {
        document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="8" class="empty">åŠ è½½å¤±è´¥</td></tr>'
      }
    }

    function renderUsersTable(users) {
      const tbody = document.getElementById('usersTableBody')
      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty">æš‚æ— æ•°æ®</td></tr>'
        return
      }
      tbody.innerHTML = users.map(user => `
        <tr>
          <td>${user.id}</td>
          <td>${user.username || '-'}</td>
          <td>${user.nickname || '-'}</td>
          <td>${user.name || '-'}</td>
          <td>${user.phone || '-'}</td>
          <td>${user.email || '-'}</td>
          <td>${formatDate(user.created_at)}</td>
          <td>${user.last_login_at ? formatDate(user.last_login_at) : '-'}</td>
        </tr>
      `).join('')
    }

    function searchUsers() {
      loadUsers(1)
    }

    // åŠ è½½å¥½å‹å…³ç³»
    async function loadFriends(page = 1) {
      currentPages.friends = page
      try {
        const res = await fetch(`${API_BASE}/admin/friends?page=${page}&pageSize=50`)
        const data = await res.json()
        if (data.success) {
          renderFriendsTable(data.data.list)
          renderPagination('friendsPagination', data.data.pagination, loadFriends)
        }
      } catch (error) {
        document.getElementById('friendsTableBody').innerHTML = '<tr><td colspan="3" class="empty">åŠ è½½å¤±è´¥</td></tr>'
      }
    }

    function renderFriendsTable(friends) {
      const tbody = document.getElementById('friendsTableBody')
      if (friends.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="empty">æš‚æ— æ•°æ®</td></tr>'
        return
      }
      tbody.innerHTML = friends.map(f => `
        <tr>
          <td>${f.user_nickname || f.user_name || f.user_username || f.user_id}</td>
          <td>${f.friend_nickname || f.friend_name || f.friend_username || f.friend_id}</td>
          <td>${formatDate(f.created_at)}</td>
        </tr>
      `).join('')
    }

    // åŠ è½½æ—¥ç¨‹åˆ—è¡¨
    async function loadSchedules(page = 1) {
      currentPages.schedules = page
      const userId = document.getElementById('scheduleUserId').value
      const status = document.getElementById('scheduleStatus').value
      const date = document.getElementById('scheduleDate').value
      try {
        const params = new URLSearchParams({ page, pageSize: 50 })
        if (userId) params.append('userId', userId)
        if (status) params.append('status', status)
        if (date) params.append('date', date)
        const res = await fetch(`${API_BASE}/admin/schedules?${params}`)
        const data = await res.json()
        if (data.success) {
          renderSchedulesTable(data.data.list)
          renderPagination('schedulesPagination', data.data.pagination, loadSchedules)
        }
      } catch (error) {
        document.getElementById('schedulesTableBody').innerHTML = '<tr><td colspan="7" class="empty">åŠ è½½å¤±è´¥</td></tr>'
      }
    }

    function renderSchedulesTable(schedules) {
      const tbody = document.getElementById('schedulesTableBody')
      if (schedules.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty">æš‚æ— æ•°æ®</td></tr>'
        return
      }
      tbody.innerHTML = schedules.map(s => `
        <tr>
          <td>${s.id}</td>
          <td>${s.nickname || s.user_name || s.username || s.user_id}</td>
          <td>${s.date}</td>
          <td>${s.start_time} - ${s.end_time}</td>
          <td>${renderStatusBadge(s.status)}</td>
          <td>${s.isPublic ? '<span class="badge badge-info">å…¬å¼€</span>' : '<span class="badge">ç§æœ‰</span>'}</td>
          <td>${formatDate(s.created_at)}</td>
        </tr>
      `).join('')
    }

    function searchSchedules() {
      loadSchedules(1)
    }

    // åŠ è½½é¢„çº¦è¯·æ±‚
    async function loadRequests(page = 1) {
      currentPages.requests = page
      const status = document.getElementById('requestStatus').value
      const ownerId = document.getElementById('requestOwnerId').value
      const guestId = document.getElementById('requestGuestId').value
      try {
        const params = new URLSearchParams({ page, pageSize: 50 })
        if (status) params.append('status', status)
        if (ownerId) params.append('ownerId', ownerId)
        if (guestId) params.append('guestId', guestId)
        const res = await fetch(`${API_BASE}/admin/requests?${params}`)
        const data = await res.json()
        if (data.success) {
          renderRequestsTable(data.data.list)
          renderPagination('requestsPagination', data.data.pagination, loadRequests)
        }
      } catch (error) {
        document.getElementById('requestsTableBody').innerHTML = '<tr><td colspan="8" class="empty">åŠ è½½å¤±è´¥</td></tr>'
      }
    }

    function renderRequestsTable(requests) {
      const tbody = document.getElementById('requestsTableBody')
      if (requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty">æš‚æ— æ•°æ®</td></tr>'
        return
      }
      tbody.innerHTML = requests.map(r => `
        <tr>
          <td>${r.id}</td>
          <td>${r.owner_nickname || r.owner_name || r.owner_username || r.owner_id}</td>
          <td>${r.guest_nickname || r.guest_name || r.guest_username || r.guest_id}</td>
          <td>${r.date}</td>
          <td>${r.start_time} - ${r.end_time}</td>
          <td>${renderStatusBadge(r.status)}</td>
          <td>${r.note || '-'}</td>
          <td>${formatDate(r.created_at)}</td>
        </tr>
      `).join('')
    }

    function searchRequests() {
      loadRequests(1)
    }

    // å·¥å…·å‡½æ•°
    function renderStatusBadge(status) {
      const badges = {
        available: '<span class="badge badge-success">å¯ç”¨</span>',
        booked: '<span class="badge badge-info">å·²é¢„çº¦</span>',
        pending: '<span class="badge badge-warning">å¾…å®¡æ ¸</span>',
        approved: '<span class="badge badge-success">å·²åŒæ„</span>',
        rejected: '<span class="badge badge-danger">å·²é©³å›</span>'
      }
      return badges[status] || status
    }

    function getStatusLabel(status) {
      const labels = {
        available: 'å¯ç”¨',
        booked: 'å·²é¢„çº¦',
        pending: 'å¾…å®¡æ ¸',
        approved: 'å·²åŒæ„',
        rejected: 'å·²é©³å›'
      }
      return labels[status] || status
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-'
      const date = new Date(dateStr)
      return date.toLocaleString('zh-CN', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      })
    }

    function renderPagination(containerId, pagination, loadFn) {
      const container = document.getElementById(containerId)
      if (pagination.totalPages <= 1) {
        container.innerHTML = ''
        return
      }
      container.innerHTML = `
        <button onclick="${loadFn.name}(${pagination.page - 1})" ${pagination.page === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
        <span class="page-info">ç¬¬ ${pagination.page} / ${pagination.totalPages} é¡µ (å…± ${pagination.total} æ¡)</span>
        <button onclick="${loadFn.name}(${pagination.page + 1})" ${pagination.page === pagination.totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
      `
    }
  </script>
</body>
</html>

