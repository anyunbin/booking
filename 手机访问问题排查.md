# 手机访问服务器问题排查指南

## 问题：Provisional headers are shown

这个错误通常表示请求被阻止，还没有真正发送到服务器。

## 排查步骤

### 1. 检查服务器是否正在运行

```bash
# 检查3000端口是否被占用
lsof -i :3000

# 或者
netstat -an | grep 3000
```

如果服务器没有运行，启动它：
```bash
npm start
```

### 2. 检查服务器监听地址

确保服务器监听在 `0.0.0.0` 而不是 `localhost`：

```javascript
// server/index.js
app.listen(PORT, '0.0.0.0', () => {
  console.log(`服务器运行在 http://localhost:${PORT}`)
  console.log(`局域网访问: http://11.0.119.60:${PORT}`)
})
```

### 3. 检查IP地址配置

**获取本机IP地址：**
```bash
# macOS/Linux
ifconfig | grep "inet " | grep -v 127.0.0.1

# Windows
ipconfig
```

**更新 app.js 中的IP地址：**
```javascript
// app.js
apiBaseUrl: 'http://11.0.119.60:3000/api'  // 使用你的实际IP
```

### 4. 检查网络连接

**确保手机和电脑在同一WiFi网络：**

1. 在手机上打开浏览器
2. 访问：`http://11.0.119.60:3000/api/schedules`
3. 如果能看到JSON响应，说明网络连接正常
4. 如果无法访问，检查：
   - 手机和电脑是否连接同一个WiFi
   - 防火墙是否阻止了3000端口

### 5. 检查防火墙设置

**macOS：**
```bash
# 检查防火墙状态
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate

# 如果需要，允许Node.js通过防火墙
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /usr/local/bin/node
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --unblockapp /usr/local/bin/node
```

**或者临时关闭防火墙测试：**
- 系统设置 → 网络 → 防火墙 → 关闭防火墙

### 6. 检查CORS配置

确保服务器CORS配置正确：

```javascript
// server/index.js
app.use(cors({
  origin: '*',
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true
}))
```

### 7. 测试服务器连接

**在电脑上测试：**
```bash
# 测试本地连接
curl http://localhost:3000/api/schedules

# 测试IP连接
curl http://11.0.119.60:3000/api/schedules
```

**在手机上测试：**
1. 打开手机浏览器
2. 访问：`http://11.0.119.60:3000/api/schedules`
3. 应该能看到JSON数据

### 8. 检查微信开发者工具设置

在微信开发者工具中：
1. 点击右上角"详情"
2. 在"本地设置"中
3. ✅ **勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**

### 9. 查看服务器日志

启动服务器后，查看是否有请求到达：

```bash
npm start
```

如果手机发送请求，应该能在终端看到日志：
```
[2025-01-28T10:30:45.123Z] GET /api/schedules - IP: 192.168.1.100
```

如果没有看到日志，说明请求根本没有到达服务器。

## 常见问题解决

### 问题1：服务器只监听localhost

**解决：**
```javascript
// 修改 server/index.js
app.listen(PORT, '0.0.0.0', () => {
  // 监听所有网络接口
})
```

### 问题2：IP地址变化

如果电脑重新连接WiFi，IP地址可能变化：

1. 重新获取IP地址
2. 更新 `app.js` 中的 `apiBaseUrl`
3. 重新编译小程序

### 问题3：防火墙阻止

**macOS临时关闭防火墙：**
- 系统设置 → 网络 → 防火墙 → 关闭

**或者允许Node.js通过防火墙：**
```bash
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /usr/local/bin/node
```

### 问题4：端口被占用

```bash
# 查找占用3000端口的进程
lsof -i :3000

# 杀死进程
kill -9 <PID>
```

### 问题5：网络隔离

某些WiFi网络（如公司网络）可能启用了客户端隔离，阻止设备间通信。

**解决：**
- 使用手机热点
- 或使用同一路由器的不同频段（2.4G/5G）

## 快速测试脚本

创建一个测试脚本 `test-server.js`：

```javascript
// test-server.js
const http = require('http')

const options = {
  hostname: '11.0.119.60',
  port: 3000,
  path: '/api/schedules',
  method: 'GET'
}

const req = http.request(options, (res) => {
  console.log(`状态码: ${res.statusCode}`)
  res.on('data', (d) => {
    process.stdout.write(d)
  })
})

req.on('error', (e) => {
  console.error(`请求错误: ${e.message}`)
})

req.end()
```

运行测试：
```bash
node test-server.js
```

## 完整检查清单

- [ ] 服务器正在运行
- [ ] 服务器监听在 `0.0.0.0` 而不是 `localhost`
- [ ] `app.js` 中的IP地址正确
- [ ] 手机和电脑在同一WiFi网络
- [ ] 防火墙允许3000端口
- [ ] CORS配置正确
- [ ] 微信开发者工具关闭了域名校验
- [ ] 可以在手机浏览器访问服务器

## 如果还是不行

1. **查看服务器日志**：检查是否有请求到达
2. **使用手机浏览器测试**：先确保浏览器能访问
3. **检查网络**：尝试使用手机热点
4. **查看错误详情**：在微信开发者工具的真机调试中查看详细错误信息

