# 微信小程序网络问题排查指南

## 问题描述
微信扫码体验版登录时显示"网络不通"错误。

## 常见原因及解决方案

### 1. ⚠️ **合法域名未配置（最常见）**

微信小程序要求所有网络请求必须使用 HTTPS，且域名必须在微信公众平台配置。

**解决步骤：**

1. 登录 [微信公众平台](https://mp.weixin.qq.com)
2. 进入 **开发** → **开发设置**
3. 找到 **服务器域名** 部分
4. 在 **request 合法域名** 中添加：
   ```
   https://express-iayq-202839-6-1388611962.sh.run.tcloudbase.com
   ```
5. 点击保存
6. **重新上传小程序代码**（这一步很重要！）

### 2. 🔍 **检查云托管服务状态**

确保云托管服务正常运行：

1. 登录微信云托管控制台
2. 查看服务状态是否为 **运行中**
3. 检查实例是否正常启动
4. 查看运行日志，确认没有错误

**查看日志的方法：**
- 在云托管控制台 → **运行日志** 标签
- 查看是否有错误信息
- 确认数据库是否正确初始化

### 3. 🧪 **使用开发者工具调试**

在微信开发者工具中查看详细的网络请求信息：

1. 打开微信开发者工具
2. 进入 **调试器** → **Console** 标签
3. 尝试登录，查看控制台输出
4. 查看以下日志信息：
   - `登录请求 URL:` - 确认 URL 是否正确
   - `API Base URL:` - 确认基础 URL 是否正确
   - `登录响应:` - 查看服务器返回的响应
   - `错误详情:` - 如果失败，查看具体错误信息

### 4. 🌐 **检查网络连接**

- 确保手机/模拟器能访问互联网
- 尝试在浏览器中直接访问：
  ```
  https://express-iayq-202839-6-1388611962.sh.run.tcloudbase.com/api/auth/login
  ```
  （应该返回 404 或其他 HTTP 错误，但不应该是连接超时）

### 5. 🔐 **HTTPS 证书问题**

云托管域名应该已经配置了有效的 SSL 证书，但如果有问题：

1. 在浏览器中访问该域名，检查证书是否有效
2. 如果证书过期或无效，需要在云托管控制台重新配置

### 6. 📝 **检查 API 基础 URL 配置**

确认 `app.js` 中的 `apiBaseUrl` 配置正确：

```javascript
apiBaseUrl: 'https://express-iayq-202839-6-1388611962.sh.run.tcloudbase.com/api'
```

- 必须使用 HTTPS（不能是 HTTP）
- 必须包含 `/api` 路径
- 不能有多余的斜杠

## 调试步骤总结

### 第一步：配置合法域名
1. 在微信公众平台添加域名
2. 重新上传小程序代码

### 第二步：验证云托管服务
1. 检查服务是否运行
2. 查看运行日志

### 第三步：使用开发者工具调试
1. 打开控制台
2. 查看请求 URL 和错误信息
3. 根据错误信息进行相应调整

### 第四步：测试网络连接
1. 在浏览器中访问 API 地址
2. 确认网络连接正常

## 常见错误信息及解决方案

| 错误信息 | 原因 | 解决方案 |
|---------|------|--------|
| 网络错误，请检查连接 | 域名未配置或网络不通 | 在微信公众平台配置合法域名 |
| 请求超时 | 云托管服务未启动或响应慢 | 检查云托管服务状态 |
| 域名不合法 | 域名未在微信平台配置 | 添加域名到合法域名列表 |
| 登录失败 | 用户名或密码错误 | 检查输入的用户名和密码 |

## 如果问题仍未解决

1. **查看云托管日志**
   - 登录微信云托管控制台
   - 查看 **运行日志** 中是否有错误信息
   - 检查数据库是否正确初始化

2. **检查小程序代码**
   - 确认 `app.js` 中的 `apiBaseUrl` 配置正确
   - 查看 `pages/login/login.js` 中的网络请求代码

3. **重新部署**
   - 在微信云托管中重新部署应用
   - 确保最新的代码已部署

4. **联系技术支持**
   - 提供详细的错误日志
   - 提供云托管的运行日志
   - 提供小程序的控制台输出

## 相关文件

- `app.js` - 全局配置，包含 `apiBaseUrl`
- `pages/login/login.js` - 登录页面，包含网络请求代码
- `server/index.js` - 后端服务器配置
- `Dockerfile` - Docker 容器配置

## 更新日志

- 2025-11-26：添加调试日志到登录页面
- 2025-11-26：更新 apiBaseUrl 为云托管域名
- 2025-11-26：创建 Dockerfile 支持云托管部署

