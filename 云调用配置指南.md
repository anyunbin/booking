# 微信云托管云调用配置指南

## 概述

本项目已升级为使用微信云托管的 **云调用** 功能（`wx.cloud.callContainer`），相比传统的 `wx.request` 有以下优势：

✅ **不需要配置合法域名** - 解决了之前的域名配置问题
✅ **走内网通信** - 不耗费公网流量
✅ **天然免疫 DDoS** - 仅授权小程序可访问
✅ **性能更好** - 通过微信就近接入节点加速
✅ **自动获取用户信息** - 后端可直接获取 openid 等

## 配置步骤

### 1. 获取云托管环境信息

你需要从微信云托管控制台获取以下信息：

#### 环境 ID
- 登录 [微信云托管控制台](https://console.cloud.tencent.com/tcb)
- 在左侧菜单找到你的环境
- 环境 ID 通常格式为：`prod-xxxxxxxxxxxxxxxx`
- 在 `app.js` 中的 `cloudEnv` 字段填入

#### 服务名称
- 在云托管控制台 → **服务管理** → **服务列表**
- 找到你的服务（例如：`express-iayq`）
- 在 `app.js` 中的 `cloudService` 字段填入

### 2. 更新 app.js 配置

打开 `app.js`，找到以下配置并替换为你的实际值：

```javascript
this.globalData = {
  // ... 其他配置
  cloudEnv: 'prod-0gn9dgzia67371b0',      // 替换为你的环境ID
  cloudService: 'express-iayq',            // 替换为你的服务名称
  apiBaseUrl: 'https://...'                // 备用公网地址
}
```

### 3. 更新小程序基础库版本

云调用需要基础库版本 **2.23.0 及以上**：

1. 登录 [微信公众平台](https://mp.weixin.qq.com)
2. 进入 **开发** → **开发设置**
3. 找到 **基础库最低版本设置**
4. 将值设定为 **2.23.0 或更高**

### 4. 关闭公网访问（可选但推荐）

如果云托管服务只有小程序会调用，建议关闭公网访问以提高安全性：

1. 登录微信云托管控制台
2. 进入服务设置
3. 找到 **公网访问** 选项
4. 关闭公网访问

## 使用方法

### 方法 1：智能调用（推荐）

优先使用云调用，失败时自动降级到公网访问：

```javascript
const app = getApp()

// 在页面中使用
async handleLogin() {
  try {
    const result = await app.call({
      path: '/auth/login',
      method: 'POST',
      data: {
        username: 'user123',
        password: 'password123'
      }
    })
    console.log('登录成功:', result)
  } catch (err) {
    console.error('登录失败:', err)
  }
}
```

### 方法 2：仅使用云调用

```javascript
const result = await app.callCloud({
  path: '/auth/login',
  method: 'POST',
  data: { username: 'user123', password: 'password123' }
})
```

### 方法 3：仅使用公网访问

```javascript
const result = await app.callPublic({
  path: '/auth/login',
  method: 'POST',
  data: { username: 'user123', password: 'password123' }
})
```

## API 参数说明

### call(options) / callCloud(options) / callPublic(options)

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| path | string | 是 | 请求路径，如 `/auth/login` |
| method | string | 否 | HTTP 方法，默认 `GET`，可选 `POST`、`PUT`、`DELETE` 等 |
| data | object | 否 | 请求数据 |
| header | object | 否 | 自定义请求头 |

### 返回值

返回 Promise，resolve 时返回响应数据（`result.data`）

## 常见问题

### Q1: 云调用失败，显示"Cloud API isn't enabled"

**原因**：云托管服务未启用云调用功能

**解决**：
1. 登录微信云托管控制台
2. 进入服务设置
3. 确保 **云调用** 功能已启用

### Q2: 云调用失败，显示"环境不存在"

**原因**：`cloudEnv` 配置错误

**解决**：
1. 检查 `app.js` 中的 `cloudEnv` 是否正确
2. 确保环境 ID 格式正确（通常为 `prod-xxxxxxxxxxxxxxxx`）

### Q3: 云调用失败，显示"服务不存在"

**原因**：`cloudService` 配置错误

**解决**：
1. 检查 `app.js` 中的 `cloudService` 是否正确
2. 在云托管控制台确认服务名称

### Q4: 为什么有时候用云调用，有时候用公网访问？

**原因**：使用了智能调用方法 `app.call()`，它会自动选择最佳方案

**说明**：
- 优先尝试云调用（更快、更安全）
- 如果云调用失败，自动降级到公网访问（保证可用性）
- 这样可以在云调用不可用时仍然保证服务可用

## 后端配置

### Node.js/Express 后端

后端无需特殊配置，继续使用现有的 Express 路由即可。

云调用时，请求头会自动包含：
- `X-WX-SERVICE`: 服务名称
- `X-WX-OPENID`: 用户 openid（如果已授权）
- `X-WX-UNIONID`: 用户 unionid（如果已授权）
- 其他微信相关信息

### 获取用户信息

在后端可以直接从请求头获取用户信息，无需额外的登录流程：

```javascript
// Express 示例
app.post('/api/auth/login', (req, res) => {
  // 从请求头获取用户信息
  const openid = req.headers['x-wx-openid']
  const unionid = req.headers['x-wx-unionid']

  // 使用这些信息进行业务处理
  // ...
})
```

## 迁移指南

如果你有其他页面仍在使用 `wx.request`，可以按照以下步骤迁移：

### 旧代码（wx.request）
```javascript
wx.request({
  url: `${app.globalData.apiBaseUrl}/auth/login`,
  method: 'POST',
  data: { username, password },
  success: (res) => { /* ... */ },
  fail: (err) => { /* ... */ }
})
```

### 新代码（云调用）
```javascript
const result = await app.call({
  path: '/auth/login',
  method: 'POST',
  data: { username, password }
})
```

## 性能对比

| 指标 | wx.request | 云调用 |
|------|-----------|--------|
| 公网流量 | 消耗 | 不消耗 |
| 延迟 | 较高 | 较低 |
| DDoS 防护 | 需要自己配置 | 天然免疫 |
| 域名配置 | 需要 | 不需要 |
| 用户信息获取 | 需要额外接口 | 直接在请求头 |

## 相关文件

- `app.js` - 全局配置和云调用方法
- `pages/login/login.js` - 登录页面（已升级为云调用）
- `Dockerfile` - Docker 容器配置
- `server/index.js` - 后端服务器配置

## 更新日志

- 2025-11-26：升级为使用微信云托管云调用
- 2025-11-26：添加智能调用方法，支持自动降级
- 2025-11-26：更新登录页面使用云调用
- 2025-11-26：创建云调用配置指南

## 参考资源

- [微信云托管官方文档](https://developers.weixin.qq.com/doc/cloudbase/introduction.html)
- [wx.cloud.callContainer API](https://developers.weixin.qq.com/doc/cloudbase/api-reference/server/cloud-api/callContainer.html)
- [小程序基础库版本](https://developers.weixin.qq.com/miniprogram/dev/framework/compatibility.html)

