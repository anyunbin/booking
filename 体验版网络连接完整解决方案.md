# 体验版网络连接完整解决方案

## 问题现象
- ✅ 开发工具可以正常访问云托管
- ❌ 体验版显示网络异常

## 根本原因
体验版的小程序有严格的安全限制，必须满足以下条件才能访问网络：

1. **合法域名必须配置** - 这是最重要的
2. **域名配置后必须重新上传** - 配置不会立即生效
3. **体验版二维码必须是最新的** - 旧的二维码不会使用新配置

## 完整解决步骤

### 步骤 1：在微信公众平台配置合法域名（必须）

**这是最关键的一步！**

1. 登录 [微信公众平台](https://mp.weixin.qq.com)
   - 使用你的小程序账号登录

2. 进入 **开发** → **开发设置**

3. 找到 **服务器域名** 部分

4. 在 **request 合法域名** 中添加：
   ```
   https://express-iayq-202839-6-1388611962.sh.run.tcloudbase.com
   ```

5. 点击 **保存**
   - 会提示需要验证域名所有权
   - 按照提示完成验证（通常需要上传文件到服务器）

6. 验证完成后，域名会显示在列表中

### 步骤 2：重新上传小程序代码

**配置域名后必须重新上传！**

1. 打开微信开发者工具

2. 点击 **上传** 按钮

3. 填写版本号和备注，例如：
   - 版本号：1.0.1
   - 备注：修复体验版网络连接

4. 选择上传为 **体验版**

5. 等待上传完成

### 步骤 3：重新生成体验版二维码

1. 在微信公众平台找到 **版本管理** 或 **体验版**

2. 找到刚上传的版本

3. 生成新的体验版二维码

4. **使用新的二维码扫码**（不要使用旧的二维码）

### 步骤 4：在真机上测试

1. 用微信扫新的体验版二维码

2. 进入小程序

3. 尝试登录或注册

4. 应该能正常连接了

## 如果还是不行

### 检查清单

- [ ] 域名已在微信公众平台配置
- [ ] 域名验证已完成
- [ ] 已重新上传小程序代码
- [ ] 使用的是最新的体验版二维码
- [ ] 手机网络正常（可以访问其他网站）
- [ ] 小程序基础库版本 ≥ 2.23.0

### 调试方法

1. **在真机上打开调试**
   - 在小程序中长按 2 秒
   - 选择 **打开调试**

2. **查看网络请求**
   - 点击 **vConsole** 标签
   - 查看 **Network** 中的请求
   - 检查请求 URL 是否正确
   - 检查响应状态码

3. **查看日志**
   - 点击 **Log** 标签
   - 查看是否有错误信息

### 常见错误及解决方案

| 错误信息 | 原因 | 解决方案 |
|---------|------|--------|
| 域名不合法 | 域名未配置 | 在微信公众平台配置合法域名 |
| 网络超时 | 云托管服务未启动 | 检查云托管服务状态 |
| 请求失败 | 域名配置后未重新上传 | 重新上传小程序代码 |
| 仍然显示旧版本 | 使用了旧的二维码 | 使用最新的体验版二维码 |

## 技术细节

### 当前代码配置

体验版会自动使用公网访问：

```javascript
if (envVersion === 'trial' || envVersion === 'release') {
  console.log('体验版/正式版：使用公网访问')
  return await that.callPublic(options)
}
```

### 公网访问地址

```
https://express-iayq-202839-6-1388611962.sh.run.tcloudbase.com/api
```

这个地址必须在微信公众平台的合法域名中配置。

## 验证步骤

### 方法 1：在浏览器中测试

1. 在电脑浏览器中访问：
   ```
   https://express-iayq-202839-6-1388611962.sh.run.tcloudbase.com/api/auth/login
   ```

2. 应该返回 404 或其他 HTTP 错误（但不是连接超时）

3. 如果能访问，说明域名和服务都正常

### 方法 2：在小程序中测试

1. 在开发工具中打开控制台

2. 尝试登录

3. 查看日志中是否有错误信息

4. 检查网络请求是否成功

## 总结

**关键点：**
1. ✅ 配置合法域名（最重要）
2. ✅ 重新上传小程序
3. ✅ 使用最新的体验版二维码
4. ✅ 在真机上测试

**预期结果：**
- 体验版应该能正常访问云托管
- 登录/注册功能应该正常工作
- 网络请求应该成功

## 相关文件

- `app.js` - 网络调用配置
- `pages/login/login.js` - 登录页面
- `server/index.js` - 后端服务配置

## 更新日志

- 2025-11-26：创建体验版网络连接完整解决方案

